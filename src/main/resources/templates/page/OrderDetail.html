<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chi tiết hóa đơn</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .table td, .table th {
      vertical-align: middle;
    }
    .btn-sm {
      font-size: 0.85rem;
    }
    .page-title {
      font-weight: 700;
      color: #0d6efd;
    }
  </style>
</head>
<body>
<div th:replace="~{/header/sideBar}" class="sidebar"></div>

<div class="container py-5">


  <div class="mb-4 text-center">
    <h2 class="page-title"> Chi tiết đơn hàng</h2>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <p><strong>Mã đơn hàng:</strong> <span th:text="${order.id}"></span></p>
      <p><strong>Khách hàng:</strong> <span th:text="${order.user?.fullName ?: 'Khách lẻ'}"></span></p>
      <p><strong>Ngày tạo:</strong> <span th:text="${#dates.format(order.createdDate, 'dd/MM/yyyy HH:mm')}"></span></p>
      <p><strong>Trạng thái:</strong> <span th:text="${order.status}"></span></p>
      <p><strong>Tổng tiền hiện tại:</strong>
        <span class="text-danger fw-bold" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 2, 'POINT')} + ' đ'"></span>
      </p>
    </div>
  </div>


  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <strong> Sản phẩm trong hóa đơn</strong>
    </div>
    <div class="card-body p-0">
      <form th:action="@{/orders/update}" method="post">
        <table class="table table-bordered table-hover mb-0">
          <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Sản phẩm</th>
            <th>Giá gốc</th>
            <th>Giá giảm</th>
            <th>Số lượng</th>
            <th>Tổng</th>
            <th>Hành động</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="item, iter : ${items}">
            <td th:text="${iter.index + 1}"></td>
            <td th:text="${item.productDetails.product.productName}"></td>
            <td th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 2, 'POINT')} + ' đ'"></td>
            <td th:text="${#numbers.formatDecimal(item.discountPrice, 0, 'COMMA', 2, 'POINT')} + ' đ'"></td>
            <td>
              <input type="hidden" name="itemIds" th:value="${item.id}">
              <input type="number" name="quantities" class="form-control form-control-sm text-center" min="1"
                     th:value="${item.quantity}">
            </td>
            <td th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 2, 'POINT')} + ' đ'"></td>
            <td class="text-center">
              <form th:action="@{'/orders/delete/' + ${item.id}}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?');">
                   Xóa
                </button>
              </form>

            </td>
          </tr>
          </tbody>
        </table>

        <div class="text-end p-3">
          <button type="submit" class="btn btn-warning"> Cập nhật số lượng</button>
        </div>
      </form>
    </div>
  </div>


  <div class="card mb-4">
    <div class="card-header bg-success text-white">
      <strong> Thêm sản phẩm vào hóa đơn</strong>
    </div>
    <div class="card-body">
      <form th:action="@{/orders/add}" method="post" class="row g-3">
        <input type="hidden" name="orderId" th:value="${order.id}">
        <div class="col-md-6">
          <label class="form-label">Sản phẩm</label>
          <select name="productDetailId" class="form-select" required>
            <option value="">-- Chọn sản phẩm --</option>
            <option th:each="p : ${allProducts}"
                    th:value="${p.id}"
                    th:text="${p.product.productName + ' - ' + p.color.colorName + ' - ' + p.size.size}">
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Số lượng</label>
          <input type="number" name="quantity" class="form-control" value="1" min="1" required>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-success w-100"> Thêm sản phẩm</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quay lại danh sách hóa đơn -->
  <div class="text-center mt-4">
    <a href="/orders" class="btn btn-secondary">⬅ Quay lại danh sách</a>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const alert = document.querySelector('.alert');
    if (alert) {
      setTimeout(() => {
        alert.classList.remove('show');
      }, 3000);
    }
  });
</script>
</body>
</html>
